name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Run tests before deploying
  test-before-deploy:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Verify coverage thresholds
        run: |
          if npm run test:coverage 2>&1 | grep -q "Coverage threshold"; then
            echo "‚ùå Coverage thresholds not met! Aborting deployment."
            exit 1
          fi
          echo "‚úÖ Coverage thresholds met. Proceeding with deployment."

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-before-deploy

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Create deployment package
        run: |
          echo "Preparing deployment files..."

          # Create a clean deployment directory
          mkdir -p _site

          # Copy necessary files
          cp -r index.html _site/
          cp -r privacy.html _site/
          cp -r src _site/
          cp -r styles _site/
          cp -r views _site/
          cp -r assets _site/ 2>/dev/null || echo "No assets directory"

          # Create a manifest.json for the Power-Up
          cat > _site/manifest.json << 'EOF'
          {
            "name": "TimeUp",
            "details": "Track time on Trello cards with comprehensive reporting and unlimited entries",
            "icon": {
              "url": "./assets/icon.png"
            },
            "author": "TimeUp Team",
            "capabilities": [
              "card-buttons",
              "card-badges",
              "card-back-section"
            ],
            "connectorUrl": "./index.html"
          }
          EOF

          echo "‚úÖ Deployment package created"

      - name: Validate deployment files
        run: |
          echo "Validating deployment..."

          # Check required files exist
          REQUIRED_FILES="index.html privacy.html manifest.json"
          for file in $REQUIRED_FILES; do
            if [ ! -f "_site/$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            fi
          done

          # Check required directories exist
          REQUIRED_DIRS="src styles views"
          for dir in $REQUIRED_DIRS; do
            if [ ! -d "_site/$dir" ]; then
              echo "‚ùå Missing required directory: $dir"
              exit 1
            fi
          done

          echo "‚úÖ Deployment files validated"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment success notification
        run: |
          echo "üöÄ Deployment successful!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment propagation
        run: sleep 30

      - name: Check deployment accessibility
        run: |
          URL="${{ needs.deploy.outputs.page_url }}"

          if [ -z "$URL" ]; then
            echo "‚ö†Ô∏è  Deployment URL not available, skipping verification"
            exit 0
          fi

          echo "Checking deployment at: $URL"

          # Try to fetch the page (with retries)
          for i in {1..5}; do
            if curl -sSf "$URL" > /dev/null 2>&1; then
              echo "‚úÖ Deployment is accessible!"
              exit 0
            fi
            echo "Attempt $i/5 failed, retrying..."
            sleep 10
          done

          echo "‚ö†Ô∏è  Could not verify deployment accessibility"
          exit 0
