name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.2.3)"
        required: true
        type: string

# Restrict permissions to read-only by default
permissions:
  contents: read

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:ci

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          npm version $VERSION --no-git-tag-version

      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "Initial release" >> CHANGELOG.md
            git log --pretty=format:"* %s (%h)" >> CHANGELOG.md
          else
            echo "Changes since $LAST_TAG:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"* %s (%h)" --no-merges >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$LAST_TAG...${{ steps.version.outputs.tag }}" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Create release package
        run: |
          mkdir -p release

          # Copy necessary files for the Power-Up
          cp -r src release/
          cp -r styles release/
          cp -r views release/
          cp -r assets release/ 2>/dev/null || echo "No assets"
          cp index.html release/
          cp privacy.html release/

          # Create manifest
          cat > release/manifest.json << 'EOF'
          {
            "name": "TimeUp",
            "details": "Track time on Trello cards with comprehensive reporting and unlimited entries",
            "icon": {
              "url": "./assets/icon.png"
            },
            "author": "TimeUp Team",
            "capabilities": [
              "card-buttons",
              "card-badges",
              "card-back-section"
            ],
            "connectorUrl": "./index.html"
          }
          EOF

          # Create README for release
          cat > release/README.md << 'EOF'
          # TimeUp Trello Power-Up

          ## Installation

          1. Go to your Trello board
          2. Click "Power-Ups" in the menu
          3. Click "Custom" at the bottom
          4. Click "Add Custom Power-Up"
          5. Enter the manifest URL from GitHub Pages
          6. Click "Add"

          ## Features

          - ‚è±Ô∏è Track time on cards
          - üìä Generate time reports
          - üîÑ Unlimited time entries
          - üíæ Automatic archiving
          - üìà Coverage metrics

          For more information, visit: https://github.com/${{ github.repository }}
          EOF

          # Create archive
          cd release
          zip -r ../timeup-${{ steps.version.outputs.tag }}.zip .
          cd ..

          echo "Release package created: timeup-${{ steps.version.outputs.tag }}.zip"

      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # TimeUp ${{ steps.version.outputs.tag }}

          ## üì¶ Installation

          ### Option 1: GitHub Pages (Recommended)
          Use the live version hosted on GitHub Pages:
          ```
          https://vnicolas.github.io/TimeUp/
          ```

          ### Option 2: Download ZIP
          Download the ZIP file below and host it yourself.

          ## üìã Changelog
          EOF

          cat CHANGELOG.md >> RELEASE_NOTES.md

          cat >> RELEASE_NOTES.md << 'EOF'

          ## üß™ Testing

          This release includes:
          - ‚úÖ All tests passing (284 tests)
          - ‚úÖ Coverage > 95%
          - ‚úÖ Security audit passed

          ## üìù Documentation

          - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [CI/CD Guide](https://github.com/${{ github.repository }}/blob/main/.github/CI_CD_GUIDE.md)
          - [Contributing Guide](https://github.com/${{ github.repository }}/blob/main/.github/copilot-instructions.md)
          EOF

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            timeup-${{ steps.version.outputs.tag }}.zip
            package.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger deployment
        run: |
          echo "Release created successfully!"
          echo "Deployment to GitHub Pages will be triggered automatically"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
