# TimeUp - Trello Power-Up for Time Tracking
# Agent Rules of Engagement

## Project Overview
This is a **Trello Power-Up** for time tracking, built with pure web standards.
- **Stack**: HTML5, CSS3, Vanilla JavaScript (ES6+ modules)
- **Hosting**: GitHub Pages (static, client-side only)
- **Data Storage**: Trello's `t.set()` / `t.get()` API (scoped to card, board, or member)
- **No Build Tools**: No Webpack, Vite, or bundlers. Use native ES modules with `type="module"`.

---

## Architecture Rules

### 1. Directory Structure (Strict)
```
/
├── index.html              # Main Power-Up connector (declares capabilities)
├── views/                  # HTML files for each Power-Up capability
│   ├── card-button.html    # Card button popup
│   ├── card-badge.html     # Card badge renderer
│   ├── settings.html       # Power-Up settings panel
│   └── authorization.html  # OAuth flow (if needed)
├── src/
│   ├── services/           # Business logic & API interactions
│   │   ├── TrelloService.js    # Trello API wrapper (t.get, t.set, REST API)
│   │   ├── TimerService.js     # Timer start/stop/pause logic
│   │   └── StorageService.js   # Abstraction over t.set/t.get with error handling
│   ├── ui/                 # DOM manipulation only
│   │   ├── CardButtonUI.js     # Renders card button popup
│   │   ├── BadgeUI.js          # Renders badges
│   │   └── components/         # Reusable UI components
│   └── utils/              # Pure utility functions
│       ├── formatTime.js       # Time formatting helpers
│       ├── constants.js        # App-wide constants
│       └── validators.js       # Input validation
├── styles/
│   ├── variables.css       # CSS Custom Properties (theming)
│   ├── base.css            # Reset and base styles
│   ├── components.css      # BEM component styles
│   └── views/              # View-specific styles
│       └── card-button.css
├── assets/                 # Static assets (icons, images)
└── .agent/workflows/       # Agent workflow definitions
```

### 2. Separation of Concerns (Mandatory)
- **Services (`src/services/`)**: Handle ALL business logic and data operations
  - `TrelloService.js`: Wraps ALL Trello API calls (`t.get`, `t.set`, `t.card`, etc.)
  - `TimerService.js`: Timer state machine (start, stop, pause, calculate duration)
  - `StorageService.js`: Abstracts storage with consistent error handling
- **UI (`src/ui/`)**: Handle ONLY DOM manipulation and event binding
  - NO business logic in UI files
  - UI files import services and call their methods
  - UI files render data received from services
- **Utils (`src/utils/`)**: Pure functions with no side effects
  - Must be stateless and testable in isolation

### 3. Module Pattern (ES6 Modules Only)
```javascript
// ✅ CORRECT: Named exports for utilities
export const formatDuration = (ms) => { /* ... */ };

// ✅ CORRECT: Default export for services (singleton pattern)
const TimerService = {
  start: async (cardId) => { /* ... */ },
  stop: async (cardId) => { /* ... */ },
};
export default TimerService;

// ❌ FORBIDDEN: No IIFE patterns, no global namespace pollution
```

---

## Code Style Rules

### 1. JavaScript Standards
- **Variables**: Use `const` by default, `let` only when reassignment is needed. NEVER use `var`.
- **Functions**: Prefer arrow functions for callbacks and utilities. Use regular functions only for methods needing `this`.
- **Async/Await**: ALWAYS use `async/await` over `.then()` chains.
- **Strict Mode**: All modules are strict by default (ES modules), but add `'use strict';` to any non-module scripts.

### 2. Error Handling (Mandatory for Trello API)
ALL Trello API calls MUST be wrapped in try/catch:

```javascript
// ✅ CORRECT: Mandatory error handling
export const getTimerData = async (t, cardId) => {
  try {
    const data = await t.get('card', 'shared', 'timerData');
    return data ?? { entries: [], isRunning: false };
  } catch (error) {
    console.error('[TimerService] Failed to get timer data:', error);
    return { entries: [], isRunning: false, error: true };
  }
};

// ❌ FORBIDDEN: Unhandled promises
const data = await t.get('card', 'shared', 'timerData'); // No try/catch
```

### 3. JSDoc Documentation (Required)
ALL exported functions MUST have JSDoc comments:

```javascript
/**
 * Formats milliseconds into a human-readable duration string.
 * @param {number} ms - Duration in milliseconds
 * @param {Object} [options] - Formatting options
 * @param {boolean} [options.showSeconds=true] - Include seconds in output
 * @returns {string} Formatted duration (e.g., "2h 15m 30s")
 * @example
 * formatDuration(8130000) // "2h 15m 30s"
 */
export const formatDuration = (ms, options = {}) => {
  // ...
};
```

### 4. Naming Conventions
- **Files**: `PascalCase.js` for services/classes, `camelCase.js` for utilities
- **Functions**: `camelCase` (verbs: `getTimerData`, `startTimer`, `renderBadge`)
- **Constants**: `SCREAMING_SNAKE_CASE` (`MAX_TIMER_DURATION`, `STORAGE_KEYS`)
- **CSS Classes**: BEM notation (`timer__button`, `timer__button--active`)

---

## CSS Architecture Rules

### 1. CSS Variables for Theming (Mandatory)
Always use CSS custom properties aligned with Trello's Atlas Design System:

```css
/* styles/variables.css */
:root {
  /* Trello Atlas-inspired palette */
  --color-primary: #0079bf;
  --color-primary-hover: #026aa7;
  --color-success: #61bd4f;
  --color-warning: #f2d600;
  --color-danger: #eb5a46;
  
  /* Neutral palette */
  --color-background: #ffffff;
  --color-surface: #f4f5f7;
  --color-text-primary: #172b4d;
  --color-text-secondary: #5e6c84;
  --color-border: #dfe1e6;
  
  /* Typography */
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  --font-size-sm: 12px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  
  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  
  /* Borders & Shadows */
  --border-radius: 3px;
  --shadow-sm: 0 1px 2px rgba(9, 30, 66, 0.25);
  --shadow-md: 0 4px 8px rgba(9, 30, 66, 0.25);
}
```

### 2. BEM Naming Convention (Mandatory)
```css
/* ✅ CORRECT: BEM structure */
.timer { }                      /* Block */
.timer__display { }             /* Element */
.timer__button { }              /* Element */
.timer__button--active { }      /* Modifier */
.timer__button--disabled { }    /* Modifier */

/* ❌ FORBIDDEN: Generic or ambiguous names */
.btn { }
.active { }
.container { }
```

### 3. No Inline Styles
```html
<!-- ❌ FORBIDDEN -->
<div style="color: red; margin: 10px;">...</div>

<!-- ✅ CORRECT -->
<div class="timer__display timer__display--error">...</div>
```

---

## HTML Rules

### 1. No Inline JavaScript (Strict)
```html
<!-- ❌ FORBIDDEN: Inline script logic -->
<script>
  const timer = TrelloPowerUp.iframe();
  timer.render(() => { /* logic here */ });
</script>

<!-- ✅ CORRECT: External module -->
<script type="module" src="../src/ui/CardButtonUI.js"></script>
```

### 2. Semantic HTML5
- Use semantic elements (`<main>`, `<section>`, `<button>`, `<time>`)
- All interactive elements must be keyboard accessible
- Include proper ARIA attributes where needed

### 3. Standard HTML Template for Views
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimeUp - [View Name]</title>
  <link rel="stylesheet" href="../styles/variables.css">
  <link rel="stylesheet" href="../styles/base.css">
  <link rel="stylesheet" href="../styles/components.css">
  <!-- View-specific styles -->
  <link rel="stylesheet" href="../styles/views/[view-name].css">
</head>
<body>
  <main class="powerup-view">
    <!-- View content -->
  </main>
  
  <!-- Trello Power-Up SDK -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- View module (must be last) -->
  <script type="module" src="../src/ui/[ViewName]UI.js"></script>
</body>
</html>
```

---

## Trello Power-Up Specific Rules

### 1. Power-Up Initialization Pattern
```javascript
// index.html connector script (src/main.js)
const t = TrelloPowerUp.initialize({
  'card-buttons': async (t) => {
    // Return capability handlers
  },
  'card-badges': async (t) => {
    // Return badge configurations
  },
});
```

### 2. Storage Scopes (Know When to Use Each)
- `'card', 'shared'` - Data visible to all users on a card (timer entries)
- `'card', 'private'` - Data visible only to current user on a card
- `'board', 'shared'` - Board-wide settings (hourly rate, categories)
- `'member', 'private'` - User preferences (display format)

### 3. Always Validate Storage Data
```javascript
const data = await t.get('card', 'shared', 'timerData');
// Always provide defaults and validate structure
const safeData = {
  entries: Array.isArray(data?.entries) ? data.entries : [],
  isRunning: Boolean(data?.isRunning),
  startTime: data?.startTime ?? null,
};
```

---

## Forbidden Practices

1. ❌ **No `var` keyword** - Use `const` or `let`
2. ❌ **No inline `<script>` logic** - All JS in external modules
3. ❌ **No inline styles** - All CSS in external stylesheets
4. ❌ **No unhandled promises** - Always use try/catch for async operations
5. ❌ **No global variables** - Use ES modules for state management
6. ❌ **No jQuery or libraries** - Vanilla JS only
7. ❌ **No build steps for core functionality** - ESLint/Prettier allowed but not bundlers
8. ❌ **No hardcoded colors** - Use CSS variables
9. ❌ **No generic CSS class names** - Use BEM
10. ❌ **No functions without JSDoc** - Document all exports

---

## Git Commit Guidelines
- Use conventional commits: `feat:`, `fix:`, `docs:`, `style:`, `refactor:`
- Reference Trello capability in commit when applicable: `feat(card-badge): add time display`

---

## When Generating Code
1. Always check the directory structure before creating files
2. Import services in UI files, never duplicate logic
3. Add new CSS variables to `variables.css` before using them
4. Create a corresponding `.css` file in `styles/views/` for each new view
5. Export pure functions from utils, service objects from services

---

## TypeScript-Style Type Definitions

### Timer Data Models
```typescript
/**
 * TimerData - stored per card at 'card', 'shared', 'timerData'
 */
interface TimerData {
  entries: TimeEntry[];
  state: 'idle' | 'running' | 'paused';
  currentEntry: CurrentEntry | null;
  estimatedTime: number | null; // milliseconds, null if not set
}

/**
 * TimeEntry - a completed timing session
 */
interface TimeEntry {
  id: string;           // Format: "entry_{Date.now()}_{random9chars}"
  startTime: number;    // Unix timestamp in milliseconds
  endTime: number;      // Unix timestamp in milliseconds
  duration: number;     // Calculated: endTime - startTime - pausedDuration
  description: string;  // User-provided description (can be empty)
  createdAt: number;    // Unix timestamp when entry was created
}

/**
 * CurrentEntry - active timer session (exists only when state === 'running')
 */
interface CurrentEntry {
  startTime: number;         // When timer was started
  pausedDuration: number;    // Accumulated pause time in ms
  elapsedBeforePause?: number; // Used when paused
}

/**
 * BoardSettings - stored at 'board', 'shared', 'boardSettings'
 */
interface BoardSettings {
  hourlyRate: number | null;
  currency: string;     // Default: 'USD'
  categories: string[];
}

/**
 * UserPreferences - stored at 'member', 'private', 'userPreferences'
 */
interface UserPreferences {
  showSeconds: boolean;      // Default: true
  use24HourFormat: boolean;  // Default: true
  autoStartOnOpen: boolean;  // Default: false
}

/**
 * Service return pattern for all async operations
 */
interface ServiceResult<T = unknown> {
  success: boolean;
  data?: T;
  error?: string;
  entry?: TimeEntry; // Only for stopTimer
}
```

---

## Service API Quick Reference

### StorageService (`src/services/StorageService.js`)
```javascript
// Low-level operations
getData(t, scope, visibility, key, defaultValue?) → Promise<any>
setData(t, scope, visibility, key, value) → Promise<boolean>
removeData(t, scope, visibility, key) → Promise<boolean>

// Card-scoped shortcuts
getTimerData(t) → Promise<TimerData>
setTimerData(t, timerData) → Promise<boolean>

// Board-scoped shortcuts
getBoardSettings(t) → Promise<BoardSettings>
setBoardSettings(t, settings) → Promise<boolean>

// User-scoped shortcuts
getUserPreferences(t) → Promise<UserPreferences>
setUserPreferences(t, preferences) → Promise<boolean>
```

### TimerService (`src/services/TimerService.js`)
```javascript
startTimer(t) → Promise<ServiceResult<TimerData>>
stopTimer(t, description?) → Promise<ServiceResult<TimerData> & { entry?: TimeEntry }>
getCurrentElapsed(timerData) → number // milliseconds
setEstimate(t, estimatedTimeMs | null) → Promise<ServiceResult<TimerData>>
deleteEntry(t, entryId) → Promise<ServiceResult<TimerData>>
```

### Utility Functions (`src/utils/formatTime.js`)
```javascript
formatDuration(ms, options?) → string
// options: { showSeconds?: boolean, compact?: boolean, showDays?: boolean }
// Examples: "02:15:30" or "2h 15m 30s" (compact)

formatTimestamp(timestamp, options?) → string
// options: { use24Hour?: boolean, showDate?: boolean }

getElapsedTime(startTime) → number
sumDurations(entries) → number
getRemainingTime(entries, estimatedTime) → { remaining, isOverBudget, percentComplete } | null
parseTimeString(timeStr) → number | null
// Accepts: "1h 30m", "2h", "45m", "1.5h", "90" (minutes)
```

### Constants (`src/utils/constants.js`)
```javascript
TIMER_STATE.IDLE | RUNNING | PAUSED
STORAGE_KEYS.TIMER_DATA | BOARD_SETTINGS | USER_PREFERENCES
STORAGE_SCOPES.CARD_SHARED | CARD_PRIVATE
TIME.SECOND | MINUTE | HOUR | DAY // in milliseconds
BADGE_COLORS.DEFAULT | RUNNING | WARNING | OVER_BUDGET
DEFAULTS.TIMER_DATA | BOARD_SETTINGS | USER_PREFERENCES
APP_INFO.NAME | VERSION | POWER_UP_NAME
```

---

## Trello Power-Up SDK Patterns & Gotchas

### 1. The `t` Object
The `t` object is the Trello client. It's different in each context:
- **Connector (index.html)**: `TrelloPowerUp.initialize({...})` returns `t`
- **Iframe views**: `TrelloPowerUp.iframe()` creates `t`
- **Callbacks**: `t` is passed as first argument

### 2. Storage Scope Selection
```javascript
// ✅ Card-specific data (timer, entries) → visible to all
t.set('card', 'shared', 'timerData', data);

// ✅ Board-wide settings → visible to all
t.set('board', 'shared', 'boardSettings', settings);

// ✅ User preferences → only current user
t.set('member', 'private', 'userPreferences', prefs);

// ❌ WRONG: Using 'private' for shared data
t.set('card', 'private', 'timerData', data); // Other users won't see!
```

### 3. Dynamic Badges (Auto-Refresh)
```javascript
// ✅ For real-time updates, use dynamic function
badges.push({
    dynamic: async () => ({
        text: formatDuration(getCurrentElapsed()),
        color: 'green',
        refresh: 30, // seconds between refreshes
    }),
});

// ❌ Static badge won't update
badges.push({ text: formatDuration(elapsed), color: 'green' });
```

### 4. Popup Height Management
```javascript
// ✅ Resize popup after content changes
t.sizeTo('#container'); // Or specific element
t.sizeTo(350); // Fixed height in pixels

// ❌ Fixed height may cut off content
t.popup({ url: '...', height: 300 }); // May be too small
```

### 5. Card Refresh After Changes
```javascript
// ✅ Force card to re-render badges/buttons after data change
await t.set('card', 'shared', 'timerData', newData);
await t.cards('id'); // Triggers re-render

// ❌ Badge/button state may be stale without refresh
```

### 6. URL Signing for Iframes
```javascript
// ✅ Always sign URLs for iframe content
url: t.signUrl('./views/card-section.html')

// ❌ Unsigned URLs may fail in some contexts
url: './views/card-section.html'
```

---

## Production Checklist

Before any code is considered production-ready, verify:

### Code Quality
- [ ] All async operations wrapped in try/catch with error logging
- [ ] Console logs use `[ServiceName]` prefix: `console.error('[TimerService] ...:', error);`
- [ ] JSDoc comments on ALL exported functions
- [ ] No hardcoded strings—use `constants.js`
- [ ] No magic numbers—define in constants or explain in comments

### Data Safety
- [ ] Timer data validated with `validateTimerData()` before use
- [ ] Default values provided for all `t.get()` calls
- [ ] Arrays validated with `Array.isArray()` before iteration
- [ ] Null checks before accessing nested properties

### CSS/UI
- [ ] All colors use CSS variables from `variables.css`
- [ ] All class names follow BEM: `block__element--modifier`
- [ ] No inline styles in HTML
- [ ] Responsive design works at different popup sizes

### Testing
- [ ] Tested with timer running and stopped states
- [ ] Tested with zero entries and multiple entries
- [ ] Tested with estimate set and not set
- [ ] Tested across different cards on the same board
- [ ] Browser console shows no errors

---

## Browser Testing Patterns

### Testing in Trello
1. Open browser DevTools (F12)
2. Go to Console tab
3. Look for `[ServiceName]` prefixed logs
4. Filter by "TimeUp" or specific service names

### Common Debug Checks
```javascript
// In browser console, get current timer data:
// 1. Click on a card with the Power-Up
// 2. Open DevTools → Console
// 3. The Power-Up iframe doesn't share console, so check Network tab instead

// Check storage via Trello API:
// In card popup iframe, type in console:
TrelloPowerUp.iframe().get('card', 'shared', 'timerData').then(console.log);
```

### Performance Monitoring
- Watch for excessive re-renders (multiple setTimerData calls)
- Check Network tab for API rate limiting
- Verify update intervals are reasonable (1s for display, 30s for badges)

---

## Common Error Patterns

### "Timer already running"
**Cause**: `startTimer()` called when state is already `RUNNING`
**Fix**: Check `timerData.state` before calling

### "No active timer"
**Cause**: `stopTimer()` called when no timer is running
**Fix**: UI should hide stop button when state is `IDLE`

### Badge not updating
**Cause**: Using static badge instead of dynamic
**Fix**: Use `dynamic: async () => ({...})` pattern with `refresh` property

### Data not syncing across users
**Cause**: Using `'private'` scope for shared data
**Fix**: Use `'shared'` scope for timer data

### UI shows stale state after action
**Cause**: Not refreshing display after service call
**Fix**: Always update UI with returned `result.data` after service calls
