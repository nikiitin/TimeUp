<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimeUp - Time Report</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      color: #b6c2cf;
      background: #1d2125;
      padding: 16px;
      min-height: 100vh;
    }
    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 svg {
      width: 20px;
      height: 20px;
      stroke: #b6c2cf;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border-radius: 4px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .control-group label {
      font-size: 12px;
      color: #8c9bab;
    }
    input[type="date"] {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 3px;
      background: #282e33;
      color: #b6c2cf;
    }
    input[type="date"]:focus {
      outline: none;
      border-color: #579dff;
    }
    .btn {
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.1s;
    }
    .btn--primary {
      background: #579dff;
      color: #1d2125;
    }
    .btn--primary:hover { background: #85b8ff; }
    .btn--primary:disabled {
      background: #3b4752;
      color: #626f86;
      cursor: not-allowed;
    }
    .btn--secondary {
      background: rgba(255,255,255,0.1);
      color: #b6c2cf;
    }
    .btn--secondary:hover { background: rgba(255,255,255,0.2); }
    .loading {
      text-align: center;
      padding: 40px;
      color: #8c9bab;
    }
    .empty {
      text-align: center;
      padding: 40px;
      color: #626f86;
    }
    .report {
      margin-top: 16px;
    }
    .date-group {
      margin-bottom: 16px;
    }
    .date-header {
      font-size: 13px;
      font-weight: 600;
      color: #8c9bab;
      padding: 8px 12px;
      background: rgba(255,255,255,0.06);
      border-radius: 4px 4px 0 0;
      display: flex;
      justify-content: space-between;
    }
    .date-header__total {
      color: #4bce97;
    }
    .entries-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.03);
      border-radius: 0 0 4px 4px;
      overflow: hidden;
    }
    .entries-table th {
      text-align: left;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 500;
      color: #626f86;
      text-transform: uppercase;
      background: rgba(255,255,255,0.04);
    }
    .entries-table td {
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,0.04);
      font-size: 13px;
    }
    .entries-table td:last-child {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }
    .summary {
      margin-top: 20px;
      padding: 16px;
      background: rgba(75, 206, 151, 0.1);
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .summary__label {
      font-size: 14px;
      color: #8c9bab;
    }
    .summary__value {
      font-size: 20px;
      font-weight: 600;
      color: #4bce97;
      font-variant-numeric: tabular-nums;
    }
    .export-row {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <h1>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <polyline points="12 6 12 12 16 14"/>
    </svg>
    Time Report
  </h1>

  <div class="controls">
    <div class="control-group">
      <label for="start-date">From</label>
      <input type="date" id="start-date">
    </div>
    <div class="control-group">
      <label for="end-date">To</label>
      <input type="date" id="end-date">
    </div>
    <button class="btn btn--primary" id="btn-load">Load Report</button>
    <button class="btn btn--secondary" id="btn-export" disabled>Export CSV</button>
  </div>

  <div id="results"></div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script type="module">
    import { formatDuration } from '../src/utils/formatTime.js';
    import ReportService from '../src/services/ReportService.js';

    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const btnLoad = document.getElementById('btn-load');
    const btnExport = document.getElementById('btn-export');
    const resultsEl = document.getElementById('results');

    let currentEntries = [];
    const t = TrelloPowerUp.iframe();

    // Set default dates (last 7 days)
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    startDateInput.value = weekAgo.toISOString().split('T')[0];
    endDateInput.value = today.toISOString().split('T')[0];

    const renderReport = (groupedByDate, totalDuration) => {
      if (Object.keys(groupedByDate).length === 0) {
        resultsEl.innerHTML = '<div class="empty">No time entries found for this date range.</div>';
        btnExport.disabled = true;
        return;
      }

      let html = '<div class="report">';

      for (const [date, entries] of Object.entries(groupedByDate)) {
        const dayTotal = ReportService.calculateTotal(entries);
        const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString(undefined, {
          weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
        });

        html += `
          <div class="date-group">
            <div class="date-header">
              <span>${dateFormatted}</span>
              <span class="date-header__total">${formatDuration(dayTotal, { compact: true })}</span>
            </div>
            <table class="entries-table">
              <thead>
                <tr>
                  <th>Card</th>
                  <th>Time</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
        `;

        entries.forEach(entry => {
          const time = new Date(entry.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          html += `
            <tr>
              <td>${entry.cardName}</td>
              <td>${time}</td>
              <td>${formatDuration(entry.duration, { compact: true })}</td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
      }

      html += `
        <div class="summary">
          <span class="summary__label">Total Time</span>
          <span class="summary__value">${formatDuration(totalDuration, { compact: true })}</span>
        </div>
        <div class="export-row">
          <button class="btn btn--secondary" id="btn-export-inline">ðŸ“¥ Export CSV</button>
        </div>
      `;

      html += '</div>';
      resultsEl.innerHTML = html;
      btnExport.disabled = false;

      // Bind inline export button
      document.getElementById('btn-export-inline')?.addEventListener('click', exportReport);
    };

    const loadReport = async () => {
      resultsEl.innerHTML = '<div class="loading">Loading data from all cards...</div>';
      btnLoad.disabled = true;

      try {
        const cardData = await ReportService.fetchAllCardTimers(t);
        const allEntries = ReportService.flattenEntries(cardData);
        const filtered = ReportService.filterByDateRange(allEntries, startDateInput.value, endDateInput.value);
        currentEntries = filtered;

        const grouped = ReportService.groupByDate(filtered);
        const total = ReportService.calculateTotal(filtered);

        renderReport(grouped, total);
      } catch (error) {
        console.error('[Report] Load error:', error);
        resultsEl.innerHTML = '<div class="empty">Error loading report. Please try again.</div>';
      }

      btnLoad.disabled = false;
    };

    const exportReport = () => {
      if (currentEntries.length === 0) return;

      const csv = ReportService.generateCSV(currentEntries);
      const filename = `timeup-report-${startDateInput.value}-to-${endDateInput.value}.csv`;
      ReportService.downloadCSV(csv, filename);
    };

    btnLoad.addEventListener('click', loadReport);
    btnExport.addEventListener('click', exportReport);

    t.render(() => t.sizeTo('#results').catch(() => {}));
  </script>
</body>
</html>
